# æ ¡å›­Java-OJç³»ç»Ÿæ€»ä½“æ¶æ„è®¾è®¡

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: æ ¡å›­Java-OJåœ¨çº¿åˆ¤é¢˜ç³»ç»Ÿ  
**æŠ€æœ¯æ ˆ**: Go + MongoDB + RabbitMQ + go-judge  
**ç›®æ ‡ç”¨æˆ·**: 100-200ååœ¨æ ¡å­¦ç”Ÿ  
**æ ¸å¿ƒåŠŸèƒ½**: Javaä»£ç åœ¨çº¿è¯„æµ‹ã€é¢˜åº“ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€æˆç»©ç»Ÿè®¡

## ğŸ—ï¸ æ€»ä½“æ¶æ„è®¾è®¡

### 1. å…­å±‚æ¶æ„æ¨¡å‹

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ (Frontend Layer)"
        A1[å­¦ç”ŸWebç•Œé¢]
        A2[æ•™å¸ˆç®¡ç†ç«¯]
        A3[ç®¡ç†å‘˜æ§åˆ¶å°]
    end
    
    subgraph "ä¸šåŠ¡æœåŠ¡å±‚ (Business Service Layer)"
        B1[WebæœåŠ¡ - Ginæ¡†æ¶]
        B2[ç”¨æˆ·æœåŠ¡]
        B3[é¢˜ç›®æœåŠ¡]
        B4[æäº¤æœåŠ¡]
        B5[ç»Ÿè®¡æœåŠ¡]
        B6[æƒé™ç®¡ç†]
    end
    
    subgraph "æ¶ˆæ¯é˜Ÿåˆ—å±‚ (Message Queue Layer)"
        C1[RabbitMQ Broker]
        C2[åˆ¤é¢˜ä»»åŠ¡é˜Ÿåˆ—]
        C3[ç»“æœé€šçŸ¥é˜Ÿåˆ—]
        C4[ç»Ÿè®¡æ›´æ–°é˜Ÿåˆ—]
        C5[æ­»ä¿¡é˜Ÿåˆ—]
    end
    
    subgraph "åˆ¤é¢˜å¤„ç†å±‚ (Judge Processing Layer)"
        D1[åˆ¤é¢˜ç®¡ç†å™¨]
        D2[æ²™ç®±è´Ÿè½½å‡è¡¡å™¨]
        D3[go-judgeå®ä¾‹1:5050]
        D4[go-judgeå®ä¾‹2:5053]
        D5[æ–‡ä»¶ç¼“å­˜ç®¡ç†å™¨]
        D6[ç»“æœæ”¶é›†å™¨]
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚ (Data Storage Layer)"
        E1[MongoDBä¸»åº“]
        E2[MongoDBå‰¯æœ¬é›†]
        E3[Redisç¼“å­˜]
        E4[MinIOæ–‡ä»¶å­˜å‚¨]
    end
    
    subgraph "æ—¥å¿—å±‚ (Logging Layer)"
        F1[åº”ç”¨æ—¥å¿— - Logrus]
        F2[ç³»ç»Ÿç›‘æ§ - Prometheus]
        F3[é“¾è·¯è¿½è¸ª - Jaeger]
        F4[æ—¥å¿—èšåˆ - ELK]
    end
    
    %% è¿æ¥å…³ç³»
    A1 --> B1
    A2 --> B1
    A3 --> B1
    
    B1 --> B2
    B1 --> B3
    B1 --> B4
    B1 --> B5
    B1 --> B6
    
    B4 --> C1
    C1 --> C2
    C2 --> D1
    D1 --> D2
    D2 --> D3
    D2 --> D4
    D3 --> D5
    D4 --> D5
    D5 --> D6
    D6 --> C3
    C3 --> B4
    B4 --> C4
    C4 --> B5
    
    B2 --> E1
    B3 --> E1
    B4 --> E1
    B5 --> E1
    B1 --> E3
    D1 --> E4
    
    B1 --> F1
    D1 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> F4
```

### 2. æ¶æ„å±‚æ¬¡è¯¦è§£

#### 2.1 å‰ç«¯å±‚ (Frontend Layer)
- **å­¦ç”ŸWebç•Œé¢**: é¢˜ç›®æµè§ˆã€ä»£ç æäº¤ã€æˆç»©æŸ¥çœ‹
- **æ•™å¸ˆç®¡ç†ç«¯**: é¢˜ç›®ç®¡ç†ã€ç­çº§ç»Ÿè®¡ã€ä½œä¸šå¸ƒç½®
- **ç®¡ç†å‘˜æ§åˆ¶å°**: ç³»ç»Ÿé…ç½®ã€ç”¨æˆ·ç®¡ç†ã€ç›‘æ§é¢æ¿

#### 2.2 ä¸šåŠ¡æœåŠ¡å±‚ (Business Service Layer)
- **WebæœåŠ¡**: åŸºäºGinæ¡†æ¶çš„HTTPæœåŠ¡å™¨
- **ç”¨æˆ·æœåŠ¡**: è®¤è¯ã€æˆæƒã€ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- **é¢˜ç›®æœåŠ¡**: é¢˜ç›®CRUDã€æµ‹è¯•ç”¨ä¾‹ç®¡ç†
- **æäº¤æœåŠ¡**: ä»£ç æäº¤ã€çŠ¶æ€æŸ¥è¯¢ã€å†å²è®°å½•
- **ç»Ÿè®¡æœåŠ¡**: ç”¨æˆ·æ’åã€è§£é¢˜ç»Ÿè®¡ã€ç­çº§åˆ†æ
- **æƒé™ç®¡ç†**: RBACæƒé™æ§åˆ¶ã€APIé‰´æƒ

#### 2.3 æ¶ˆæ¯é˜Ÿåˆ—å±‚ (Message Queue Layer)
- **åˆ¤é¢˜ä»»åŠ¡é˜Ÿåˆ—**: æ¥æ”¶ä»£ç æäº¤ä»»åŠ¡
- **ç»“æœé€šçŸ¥é˜Ÿåˆ—**: åˆ¤é¢˜ç»“æœå›è°ƒ
- **ç»Ÿè®¡æ›´æ–°é˜Ÿåˆ—**: å¼‚æ­¥æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
- **æ­»ä¿¡é˜Ÿåˆ—**: å¤„ç†å¤±è´¥ä»»åŠ¡

#### 2.4 åˆ¤é¢˜å¤„ç†å±‚ (Judge Processing Layer)
- **åˆ¤é¢˜ç®¡ç†å™¨**: ä»»åŠ¡è°ƒåº¦ã€çŠ¶æ€ç®¡ç†ã€ç¼–è¯‘è¿è¡Œæµç¨‹æ§åˆ¶
- **æ²™ç®±è´Ÿè½½å‡è¡¡å™¨**: å¤šä¸ªgo-judgeå®ä¾‹çš„è´Ÿè½½åˆ†å‘å’Œå¥åº·æ£€æŸ¥
- **go-judgeå®ä¾‹é›†ç¾¤**: åŸºäºREST APIçš„å®‰å…¨ä»£ç æ‰§è¡Œç¯å¢ƒ
- **æ–‡ä»¶ç¼“å­˜ç®¡ç†å™¨**: ç®¡ç†ç¼–è¯‘äº§ç‰©(å¦‚.classæ–‡ä»¶)çš„ç¼“å­˜å’Œæ¸…ç†
- **ç»“æœæ”¶é›†å™¨**: ç»Ÿä¸€å¤„ç†åˆ¤é¢˜ç»“æœå’Œé”™è¯¯ä¿¡æ¯
#### 2.5 æ•°æ®å­˜å‚¨å±‚ (Data Storage Layer)
- **MongoDB**: ä¸»è¦ä¸šåŠ¡æ•°æ®å­˜å‚¨
- **Redis**: ç¼“å­˜ã€ä¼šè¯å­˜å‚¨
- **MinIO**: æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶å­˜å‚¨

#### 2.6 æ—¥å¿—å±‚ (Logging Layer)
- **åº”ç”¨æ—¥å¿—**: ä¸šåŠ¡æ“ä½œè®°å½•
- **ç³»ç»Ÿç›‘æ§**: æ€§èƒ½æŒ‡æ ‡é‡‡é›†
- **é“¾è·¯è¿½è¸ª**: è¯·æ±‚é“¾è·¯åˆ†æ
- **æ—¥å¿—èšåˆ**: é›†ä¸­æ—¥å¿—ç®¡ç†

## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„

```
campus-java-oj/
â”œâ”€â”€ cmd/                          # åº”ç”¨ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ server/                   # WebæœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ judger/                   # åˆ¤é¢˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ worker/                   # å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ migration/                # æ•°æ®åº“è¿ç§»å·¥å…·
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/                     # å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ config.go
â”‚   â”‚   â”œâ”€â”€ mongodb.go
â”‚   â”‚   â”œâ”€â”€ redis.go
â”‚   â”‚   â””â”€â”€ rabbitmq.go
â”‚   â”œâ”€â”€ middleware/               # HTTPä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.go              # JWTè®¤è¯
â”‚   â”‚   â”œâ”€â”€ cors.go              # è·¨åŸŸå¤„ç†
â”‚   â”‚   â”œâ”€â”€ logger.go            # è¯·æ±‚æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ ratelimit.go         # é™æµæ§åˆ¶
â”‚   â”‚   â””â”€â”€ recover.go           # å¼‚å¸¸æ¢å¤
â”‚   â”œâ”€â”€ handler/                  # HTTPå¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ auth/                # è®¤è¯ç›¸å…³
â”‚   â”‚   â”‚   â”œâ”€â”€ login.go
â”‚   â”‚   â”‚   â”œâ”€â”€ register.go
â”‚   â”‚   â”‚   â””â”€â”€ logout.go
â”‚   â”‚   â”œâ”€â”€ problem/             # é¢˜ç›®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ create.go
â”‚   â”‚   â”‚   â”œâ”€â”€ update.go
â”‚   â”‚   â”‚   â”œâ”€â”€ delete.go
â”‚   â”‚   â”‚   â”œâ”€â”€ list.go
â”‚   â”‚   â”‚   â””â”€â”€ detail.go
â”‚   â”‚   â”œâ”€â”€ submission/          # ä»£ç æäº¤
â”‚   â”‚   â”‚   â”œâ”€â”€ submit.go
â”‚   â”‚   â”‚   â”œâ”€â”€ status.go
â”‚   â”‚   â”‚   â”œâ”€â”€ list.go
â”‚   â”‚   â”‚   â””â”€â”€ detail.go
â”‚   â”‚   â”œâ”€â”€ user/                # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ profile.go
â”‚   â”‚   â”‚   â”œâ”€â”€ stats.go
â”‚   â”‚   â”‚   â””â”€â”€ list.go
â”‚   â”‚   â””â”€â”€ admin/               # ç®¡ç†åŠŸèƒ½
â”‚   â”‚       â”œâ”€â”€ dashboard.go
â”‚   â”‚       â”œâ”€â”€ users.go
â”‚   â”‚       â””â”€â”€ system.go
â”‚   â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ interfaces/          # æœåŠ¡æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.go
â”‚   â”‚   â”‚   â”œâ”€â”€ problem.go
â”‚   â”‚   â”‚   â”œâ”€â”€ submission.go
â”‚   â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â”‚   â””â”€â”€ stats.go
â”‚   â”‚   â””â”€â”€ impl/                # æœåŠ¡å®ç°
â”‚   â”‚       â”œâ”€â”€ auth_service.go
â”‚   â”‚       â”œâ”€â”€ problem_service.go
â”‚   â”‚       â”œâ”€â”€ submission_service.go
â”‚   â”‚       â”œâ”€â”€ user_service.go
â”‚   â”‚       â””â”€â”€ stats_service.go
â”‚   â”œâ”€â”€ repository/               # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ interfaces/          # ä»“åº“æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â”‚   â”œâ”€â”€ problem.go
â”‚   â”‚   â”‚   â”œâ”€â”€ submission.go
â”‚   â”‚   â”‚   â””â”€â”€ stats.go
â”‚   â”‚   â””â”€â”€ mongodb/             # MongoDBå®ç°
â”‚   â”‚       â”œâ”€â”€ user.go
â”‚   â”‚       â”œâ”€â”€ problem.go
â”‚   â”‚       â”œâ”€â”€ submission.go
â”‚   â”‚       â””â”€â”€ stats.go
â”‚   â”œâ”€â”€ model/                    # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â”œâ”€â”€ problem.go
â”‚   â”‚   â”œâ”€â”€ submission.go
â”‚   â”‚   â”œâ”€â”€ contest.go
â”‚   â”‚   â””â”€â”€ stats.go
â”‚   â”œâ”€â”€ judge/                    # åˆ¤é¢˜ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ manager.go           # åˆ¤é¢˜ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ balancer.go          # æ²™ç®±è´Ÿè½½å‡è¡¡å™¨
â”‚   â”‚   â”œâ”€â”€ client.go            # go-judge HTTPå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ java_judge.go        # Javaç¼–è¯‘è¿è¡Œé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ result_processor.go  # åˆ¤é¢˜ç»“æœå¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ file_manager.go      # ç¼“å­˜æ–‡ä»¶ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ sandbox_pool.go      # æ²™ç®±å®ä¾‹æ± ç®¡ç†
â”‚   â”‚   â””â”€â”€ error_handler.go     # é”™è¯¯å¤„ç†å’Œé‡è¯•
â”‚   â”œâ”€â”€ queue/                    # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â”œâ”€â”€ producer.go          # æ¶ˆæ¯ç”Ÿäº§è€…
â”‚   â”‚   â”œâ”€â”€ consumer.go          # æ¶ˆæ¯æ¶ˆè´¹è€…
â”‚   â”‚   â”œâ”€â”€ judge_task.go        # åˆ¤é¢˜ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ result_handler.go    # ç»“æœå¤„ç†
â”‚   â”‚   â””â”€â”€ stats_updater.go     # ç»Ÿè®¡æ›´æ–°
â”‚   â””â”€â”€ pkg/                      # å·¥å…·åŒ…
â”‚       â”œâ”€â”€ database/            # æ•°æ®åº“è¿æ¥
â”‚       â”‚   â”œâ”€â”€ mongodb.go
â”‚       â”‚   â””â”€â”€ redis.go
â”‚       â”œâ”€â”€ logger/              # æ—¥å¿—å·¥å…·
â”‚       â”‚   â”œâ”€â”€ logger.go
â”‚       â”‚   â””â”€â”€ context.go
â”‚       â”œâ”€â”€ cache/               # ç¼“å­˜å·¥å…·
â”‚       â”‚   â””â”€â”€ redis.go
â”‚       â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ hash.go
â”‚       â”‚   â”œâ”€â”€ jwt.go
â”‚       â”‚   â”œâ”€â”€ response.go
â”‚       â”‚   â”œâ”€â”€ validator.go
â”‚       â”‚   â””â”€â”€ pagination.go
â”‚       â””â”€â”€ errors/              # é”™è¯¯å®šä¹‰
â”‚           â”œâ”€â”€ codes.go
â”‚           â””â”€â”€ errors.go
â”œâ”€â”€ api/                          # APIå®šä¹‰
â”‚   â”œâ”€â”€ openapi/                 # OpenAPIæ–‡æ¡£
â”‚   â”‚   â””â”€â”€ swagger.yaml
â”‚   â””â”€â”€ proto/                   # gRPCå®šä¹‰(é¢„ç•™)
â”œâ”€â”€ web/                          # å‰ç«¯èµ„æº
â”‚   â”œâ”€â”€ static/                  # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ templates/               # HTMLæ¨¡æ¿
â”‚   â””â”€â”€ dist/                    # æ„å»ºè¾“å‡º
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml
â”‚   â”œâ”€â”€ config.example.yaml
â”‚   â”œâ”€â”€ rbac.yaml               # æƒé™é…ç½®
â”‚   â””â”€â”€ judge.yaml              # åˆ¤é¢˜é…ç½®
â”œâ”€â”€ deployments/                  # éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â””â”€â”€ docker-compose.prod.yml
â”‚   â”œâ”€â”€ k8s/                     # Kubernetesé…ç½®
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â””â”€â”€ service.yaml
â”‚   â””â”€â”€ scripts/                 # éƒ¨ç½²è„šæœ¬
â”‚       â”œâ”€â”€ deploy.sh
â”‚       â”œâ”€â”€ backup.sh
â”‚       â””â”€â”€ migrate.sh
â”œâ”€â”€ docs/                         # æ–‡æ¡£
â”‚   â”œâ”€â”€ architecture.md         # æ¶æ„æ–‡æ¡£
â”‚   â”œâ”€â”€ api.md                  # APIæ–‡æ¡£
â”‚   â”œâ”€â”€ deployment.md           # éƒ¨ç½²æ–‡æ¡£
â”‚   â””â”€â”€ development.md          # å¼€å‘æŒ‡å—
â”œâ”€â”€ tests/                        # æµ‹è¯•
â”‚   â”œâ”€â”€ unit/                   # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ e2e/                    # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â””â”€â”€ fixtures/               # æµ‹è¯•æ•°æ®
â”œâ”€â”€ scripts/                      # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ build.sh                # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ test.sh                 # æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ lint.sh                 # ä»£ç æ£€æŸ¥
â”‚   â””â”€â”€ seed.sh                 # æ•°æ®åˆå§‹åŒ–
â”œâ”€â”€ go.mod                       # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum                       # ä¾èµ–æ ¡éªŒ
â”œâ”€â”€ Makefile                     # æ„å»ºé…ç½®
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ README.md
â””â”€â”€ LICENSE
```

## ğŸ”„ åˆ¤é¢˜æµç¨‹ä¸šåŠ¡åˆ†æ

### 1. å®Œæ•´åˆ¤é¢˜æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant S as å­¦ç”Ÿå‰ç«¯
    participant W as WebæœåŠ¡
    participant MQ as RabbitMQ
    participant JM as åˆ¤é¢˜ç®¡ç†å™¨
    participant GJ as go-judgeæ²™ç®±
    participant DB as MongoDB
    participant R as Redis
    participant WS as WebSocket

    Note over S,WS: 1. ä»£ç æäº¤é˜¶æ®µ
    S->>W: POST /api/submissions (æäº¤ä»£ç )
    W->>W: å‚æ•°æ ¡éªŒå’Œæƒé™éªŒè¯
    W->>DB: åˆ›å»ºæäº¤è®°å½•(çŠ¶æ€:PENDING)
    W->>R: ç¼“å­˜æäº¤ä¿¡æ¯
    W->>MQ: å‘é€åˆ°åˆ¤é¢˜ä»»åŠ¡é˜Ÿåˆ—
    W->>S: è¿”å›æäº¤IDå’ŒçŠ¶æ€

    Note over S,WS: 2. å¼‚æ­¥åˆ¤é¢˜é˜¶æ®µ
    MQ->>JM: æ¶ˆè´¹åˆ¤é¢˜ä»»åŠ¡
    JM->>DB: æ›´æ–°çŠ¶æ€ä¸ºJUDGING
    JM->>DB: è·å–é¢˜ç›®å’Œæµ‹è¯•ç”¨ä¾‹
    JM->>GJ: POST /run (ç¼–è¯‘Javaä»£ç )
    GJ->>JM: è¿”å›ç¼–è¯‘ç»“æœå’Œclassæ–‡ä»¶ID
    
    alt ç¼–è¯‘æˆåŠŸ(status: Accepted)
        loop æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹
            JM->>GJ: POST /run (è¿è¡Œ,ä½¿ç”¨ç¼“å­˜çš„classæ–‡ä»¶)
            GJ->>JM: è¿”å›è¿è¡Œç»“æœ(æ—¶é—´ã€å†…å­˜ã€è¾“å‡º)
            JM->>JM: æ¯”å¯¹è¾“å‡ºç»“æœ
        end
        JM->>GJ: DELETE /file/{fileId} (æ¸…ç†ç¼“å­˜æ–‡ä»¶)
        JM->>JM: è®¡ç®—æœ€ç»ˆå¾—åˆ†å’ŒçŠ¶æ€
    else ç¼–è¯‘å¤±è´¥(status: Nonzero Exit Status)
        JM->>JM: è§£æstderrè®¾ç½®ç¼–è¯‘é”™è¯¯
    end

    Note over S,WS: 3. ç»“æœå¤„ç†é˜¶æ®µ
    JM->>MQ: å‘é€åˆ°ç»“æœé€šçŸ¥é˜Ÿåˆ—
    MQ->>W: æ¶ˆè´¹ç»“æœé€šçŸ¥
    W->>DB: æ›´æ–°æäº¤ç»“æœ
    W->>R: æ›´æ–°ç¼“å­˜
    W->>WS: WebSocketæ¨é€ç»“æœ
    WS->>S: å®æ—¶é€šçŸ¥åˆ¤é¢˜ç»“æœ
    
    Note over S,WS: 4. å¼‚æ­¥ç»Ÿè®¡æ›´æ–°
    W->>MQ: å‘é€ç»Ÿè®¡æ›´æ–°ä»»åŠ¡
    MQ->>W: æ¶ˆè´¹ç»Ÿè®¡ä»»åŠ¡
    W->>DB: æ›´æ–°ç”¨æˆ·ACæ•°
    W->>DB: æ›´æ–°é¢˜ç›®ç»Ÿè®¡
    W->>R: æ›´æ–°æ’è¡Œæ¦œç¼“å­˜
```

### 2. è¯¦ç»†ä¸šåŠ¡æµç¨‹åˆ†æ

#### 2.1 ä»£ç æäº¤é˜¶æ®µ (100-200ms)

**æ ¸å¿ƒæ­¥éª¤**:
1. **å‰ç«¯æäº¤**: å­¦ç”Ÿåœ¨Webç•Œé¢æäº¤Javaä»£ç 
2. **å‚æ•°æ ¡éªŒ**: éªŒè¯ä»£ç é•¿åº¦ã€è¯­è¨€ç±»å‹ã€é¢˜ç›®å­˜åœ¨æ€§
3. **æƒé™éªŒè¯**: JWT tokenéªŒè¯ã€æäº¤æƒé™æ£€æŸ¥
4. **é˜²é‡å¤æäº¤**: æ£€æŸ¥çŸ­æ—¶é—´å†…é‡å¤æäº¤
5. **åˆ›å»ºè®°å½•**: MongoDBä¸­åˆ›å»ºæäº¤è®°å½•ï¼ŒçŠ¶æ€ä¸ºPENDING
6. **ç¼“å­˜æ›´æ–°**: Redisä¸­ç¼“å­˜æœ€æ–°æäº¤ä¿¡æ¯
7. **ä»»åŠ¡å…¥é˜Ÿ**: å‘é€åˆ¤é¢˜ä»»åŠ¡åˆ°RabbitMQ
8. **ç«‹å³å“åº”**: è¿”å›æäº¤IDï¼Œä¸ç­‰å¾…åˆ¤é¢˜ç»“æœ

**å…³é”®ä»£ç é€»è¾‘**:
```go
type SubmitRequest struct {
    ProblemID string `json:"problem_id" binding:"required"`
    Code      string `json:"code" binding:"required,max=50000"`
    Language  string `json:"language" binding:"required,oneof=java"`
}

func (h *SubmissionHandler) Submit(c *gin.Context) {
    // 1. å‚æ•°æ ¡éªŒ
    var req SubmitRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, "å‚æ•°é”™è¯¯")
        return
    }
    
    // 2. é˜²é‡å¤æäº¤æ£€æŸ¥
    userID := middleware.GetUserID(c)
    if h.checkDuplicate(userID, req.Code) {
        response.Error(c, "è¯·å‹¿é‡å¤æäº¤ç›¸åŒä»£ç ")
        return
    }
    
    // 3. åˆ›å»ºæäº¤è®°å½•å¹¶å…¥é˜Ÿ
    submission, err := h.service.Submit(c, userID, req)
    if err != nil {
        response.Error(c, err.Error())
        return
    }
    
    // 4. ç«‹å³è¿”å›ç»“æœ
    response.Success(c, gin.H{
        "submission_id": submission.ID,
        "status": "PENDING",
    })
}
```

#### 2.2 å¼‚æ­¥åˆ¤é¢˜é˜¶æ®µ (2-30ç§’)

**æ ¸å¿ƒæ­¥éª¤**:
1. **ä»»åŠ¡æ¶ˆè´¹**: åˆ¤é¢˜ç®¡ç†å™¨ä»RabbitMQæ¶ˆè´¹ä»»åŠ¡
2. **çŠ¶æ€æ›´æ–°**: æ›´æ–°æäº¤çŠ¶æ€ä¸ºJUDGING
3. **è·å–æ•°æ®**: ä»MongoDBè·å–é¢˜ç›®ä¿¡æ¯å’Œæµ‹è¯•ç”¨ä¾‹
4. **å®ä¾‹é€‰æ‹©**: è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©å¯ç”¨çš„go-judgeå®ä¾‹
5. **ä»£ç ç¼–è¯‘**: è°ƒç”¨go-judge REST APIç¼–è¯‘Javaä»£ç 
   - è¯·æ±‚: `POST /run` åŒ…å«javacå‘½ä»¤å’Œæºç 
   - è·å–: ç¼–è¯‘ç»“æœå’Œç¼“å­˜çš„.classæ–‡ä»¶ID
6. **æµ‹è¯•æ‰§è¡Œ**: ä½¿ç”¨ç¼“å­˜æ–‡ä»¶IDé€ä¸ªè¿è¡Œæµ‹è¯•ç”¨ä¾‹
   - è¯·æ±‚: `POST /run` åŒ…å«javaå‘½ä»¤å’Œè¾“å…¥æ•°æ®
   - ç›‘æ§: CPUæ—¶é—´ã€å†…å­˜ä½¿ç”¨ã€ç¨‹åºè¾“å‡º
7. **ç»“æœè®¡ç®—**: æ¯”å¯¹è¾“å‡ºã€ç»Ÿè®¡å¾—åˆ†ã€æ—¶é—´ã€å†…å­˜ä½¿ç”¨
8. **èµ„æºæ¸…ç†**: åˆ é™¤go-judgeä¸­çš„ç¼“å­˜æ–‡ä»¶
9. **ç»“æœå…¥é˜Ÿ**: å°†å®Œæ•´åˆ¤é¢˜ç»“æœå‘é€åˆ°ç»“æœé˜Ÿåˆ—

**åˆ¤é¢˜ä»»åŠ¡ç»“æ„**:
```go
type JudgeTask struct {
    SubmissionID primitive.ObjectID `json:"submission_id"`
    UserID       primitive.ObjectID `json:"user_id"`
    ProblemID    primitive.ObjectID `json:"problem_id"`
    Code         string             `json:"code"`
    Language     string             `json:"language"`
    TimeLimit    int                `json:"time_limit"`
    MemoryLimit  int                `json:"memory_limit"`
    TestCases    []TestCase         `json:"test_cases"`
    CreatedAt    time.Time          `json:"created_at"`
}
```

#### 2.3 ç»“æœå¤„ç†é˜¶æ®µ (50-100ms)

**æ ¸å¿ƒæ­¥éª¤**:
1. **ç»“æœæ¶ˆè´¹**: WebæœåŠ¡æ¶ˆè´¹åˆ¤é¢˜ç»“æœ
2. **æ•°æ®æ›´æ–°**: æ›´æ–°MongoDBä¸­çš„æäº¤è®°å½•
3. **ç¼“å­˜æ›´æ–°**: æ›´æ–°Redisä¸­çš„ç”¨æˆ·çŠ¶æ€
4. **å®æ—¶é€šçŸ¥**: é€šè¿‡WebSocketæ¨é€ç»™å‰ç«¯
5. **ç»Ÿè®¡ä»»åŠ¡**: å‘é€ç»Ÿè®¡æ›´æ–°ä»»åŠ¡åˆ°é˜Ÿåˆ—

#### 2.4 å¼‚æ­¥ç»Ÿè®¡æ›´æ–° (åå°å¤„ç†)

**æ ¸å¿ƒæ­¥éª¤**:
1. **ç»Ÿè®¡æ¶ˆè´¹**: æ¶ˆè´¹ç»Ÿè®¡æ›´æ–°ä»»åŠ¡
2. **ç”¨æˆ·ç»Ÿè®¡**: æ›´æ–°ç”¨æˆ·ACé¢˜æ•°ã€æ€»æäº¤æ•°
3. **é¢˜ç›®ç»Ÿè®¡**: æ›´æ–°é¢˜ç›®é€šè¿‡ç‡ã€æäº¤æ¬¡æ•°
4. **æ’è¡Œæ¦œ**: æ›´æ–°ç­çº§æ’è¡Œæ¦œç¼“å­˜
5. **æ¨èç³»ç»Ÿ**: æ ¹æ®ç”¨æˆ·è¡¨ç°æ¨èé¢˜ç›®(é¢„ç•™)

### 3. æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

#### 3.1 é˜Ÿåˆ—æ‹“æ‰‘ç»“æ„

```yaml
exchanges:
  - name: "campus.oj.topic"
    type: "topic"
    durable: true

queues:
  - name: "judge.task"
    routing_key: "task.judge.*"
    durable: true
    auto_delete: false
    
  - name: "judge.result"
    routing_key: "result.judge.*"
    durable: true
    auto_delete: false
    
  - name: "stats.update"
    routing_key: "update.stats.*"
    durable: true
    auto_delete: false
    
  - name: "notification"
    routing_key: "notify.*"
    durable: true
    auto_delete: false
    
  - name: "dead.letter"
    durable: true
    auto_delete: false
```

#### 3.2 æ¶ˆæ¯æ ¼å¼å®šä¹‰

```go
// åˆ¤é¢˜ä»»åŠ¡æ¶ˆæ¯
type JudgeTaskMessage struct {
    MessageID    string             `json:"message_id"`
    SubmissionID primitive.ObjectID `json:"submission_id"`
    Priority     int                `json:"priority"` // 1-10, 10æœ€é«˜
    RetryCount   int                `json:"retry_count"`
    CreatedAt    time.Time          `json:"created_at"`
    Payload      JudgeTask          `json:"payload"`
}

// go-judgeç¼–è¯‘è¯·æ±‚
type CompileRequest struct {
    Cmd []CommandRequest `json:"cmd"`
}

// go-judgeå‘½ä»¤è¯·æ±‚
type CommandRequest struct {
    Args          []string          `json:"args"`           // ["javac", "Main.java"]
    Env           []string          `json:"env"`            // Javaç¯å¢ƒå˜é‡
    Files         []FileDescriptor  `json:"files"`         // stdin/stdout/stderr
    CPULimit      int64            `json:"cpuLimit"`      // çº³ç§’
    MemoryLimit   int64            `json:"memoryLimit"`   // å­—èŠ‚
    ProcLimit     int              `json:"procLimit"`     // è¿›ç¨‹æ•°
    CopyIn        map[string]File  `json:"copyIn"`        // è¾“å…¥æ–‡ä»¶
    CopyOut       []string         `json:"copyOut"`       // è¾“å‡ºæ–‡ä»¶
    CopyOutCached []string         `json:"copyOutCached"` // ç¼“å­˜æ–‡ä»¶
}

// go-judgeæ–‡ä»¶æè¿°
type File struct {
    Content string `json:"content,omitempty"` // æ–‡ä»¶å†…å®¹
    FileID  string `json:"fileId,omitempty"`  // ç¼“å­˜æ–‡ä»¶ID
}

// go-judgeå“åº”
type JudgeResponse struct {
    Status     string            `json:"status"`     // Accepted/Memory Limit Exceededç­‰
    ExitStatus int               `json:"exitStatus"` // ç¨‹åºé€€å‡ºç 
    Time       int64             `json:"time"`       // CPUæ—¶é—´(çº³ç§’)
    Memory     int64             `json:"memory"`     // å†…å­˜ä½¿ç”¨(å­—èŠ‚)
    RunTime    int64             `json:"runTime"`    // å¢™é’Ÿæ—¶é—´(çº³ç§’)
    Files      map[string]string `json:"files"`      // è¾“å‡ºæ–‡ä»¶å†…å®¹
    FileIDs    map[string]string `json:"fileIds"`    // ç¼“å­˜æ–‡ä»¶IDæ˜ å°„
    FileError  []FileError       `json:"fileError,omitempty"`
}

// åˆ¤é¢˜ç»“æœæ¶ˆæ¯
type JudgeResultMessage struct {
    MessageID    string             `json:"message_id"`
    SubmissionID primitive.ObjectID `json:"submission_id"`
    Status       string             `json:"status"`
    Score        int                `json:"score"`
    TimeUsed     int                `json:"time_used"`
    MemoryUsed   int                `json:"memory_used"`
    TestResults  []TestResult       `json:"test_results"`
    CompileLog   string             `json:"compile_log,omitempty"`
    JudgedAt     time.Time          `json:"judged_at"`
}

// ç»Ÿè®¡æ›´æ–°æ¶ˆæ¯
type StatsUpdateMessage struct {
    MessageID string             `json:"message_id"`
    UserID    primitive.ObjectID `json:"user_id"`
    ProblemID primitive.ObjectID `json:"problem_id"`
    Action    string             `json:"action"` // AC, WA, TLE, etc.
    Timestamp time.Time          `json:"timestamp"`
}
```

### 4. å®¹é”™å’Œç›‘æ§æœºåˆ¶

#### 4.1 æ¶ˆæ¯é˜Ÿåˆ—å®¹é”™
- **æ­»ä¿¡é˜Ÿåˆ—**: å¤„ç†å¤±è´¥çš„æ¶ˆæ¯
- **é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- **æ¶ˆæ¯æŒä¹…åŒ–**: ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
- **æ¶ˆè´¹ç¡®è®¤**: å¤„ç†å®Œæˆåæ‰ç¡®è®¤æ¶ˆæ¯

#### 4.2 åˆ¤é¢˜æœåŠ¡å®¹é”™
- **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥go-judgeçŠ¶æ€
- **è‡ªåŠ¨é‡å¯**: æ²™ç®±å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯
- **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹è´Ÿè½½åˆ†å‘
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ä½¿ç”¨ç›‘æ§

#### 4.3 æ•°æ®ä¸€è‡´æ€§
- **äº‹åŠ¡å¤„ç†**: MongoDBäº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´
- **æœ€ç»ˆä¸€è‡´æ€§**: ç»Ÿè®¡æ•°æ®å…è®¸çŸ­æš‚ä¸ä¸€è‡´
- **è¡¥å¿æœºåˆ¶**: å¼‚å¸¸æƒ…å†µä¸‹çš„æ•°æ®ä¿®å¤
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ

è¿™ä¸ªæ¶æ„è®¾è®¡å……åˆ†è€ƒè™‘äº†AHUTOJçš„æˆç†Ÿç»éªŒï¼Œç»“åˆMongoDBçš„çµæ´»æ€§å’ŒRabbitMQçš„å¯é æ€§ï¼Œä¸ºæ ¡å›­Java-OJæä¾›äº†ä¸€ä¸ªå¯æ‰©å±•ã€é«˜å¯ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚