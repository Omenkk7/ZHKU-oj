# æ ¡å›­Java-OJç³»ç»Ÿéƒ¨ç½²é…ç½®

## ğŸ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²

### 1. å¼€å‘ç¯å¢ƒä¸€é”®éƒ¨ç½²

#### Docker Composeé…ç½®
**æ–‡ä»¶**: `deployments/docker/docker-compose.yml`

```yaml
version: '3.8'

services:
  # MongoDBæ•°æ®åº“
  mongodb:
    image: mongo:5.0
    container_name: campus-oj-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: campus123
      MONGO_INITDB_DATABASE: campus_oj
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - campus-oj-network

  # Redisç¼“å­˜
  redis:
    image: redis:6.0-alpine
    command: redis-server --requirepass campus123
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - campus-oj-network

  # RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3.9-management
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: campus123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - campus-oj-network

  # go-judgeæ²™ç®±é›†ç¾¤(åŸºäºcriyle/go-judgeéœåƒ)
  go-judge-1:
    image: criyle/go-judge:latest
    privileged: true
    shm_size: 256m
    ports:
      - "5050:5050"
    environment:
      - PARALLELISM=4
      - FILE_TIMEOUT=60
      - HTTP_TIMEOUT=30
    volumes:
      - /tmp:/tmp
    networks:
      - campus-oj-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/version"]
      interval: 30s
      timeout: 10s
      retries: 3

  go-judge-2:
    image: criyle/go-judge:latest
    privileged: true
    shm_size: 256m
    ports:
      - "5053:5050"
    environment:
      - PARALLELISM=4
      - FILE_TIMEOUT=60
      - HTTP_TIMEOUT=30
    volumes:
      - /tmp:/tmp
    networks:
      - campus-oj-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # WebæœåŠ¡
  oj-web:
    build:
      context: ../../
      dockerfile: deployments/docker/Dockerfile.web
    ports:
      - "8080:8080"
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
    volumes:
      - ../../configs:/app/configs
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - campus-oj-network

  # åˆ¤é¢˜æœåŠ¡
  oj-judger:
    build:
      context: ../../
      dockerfile: deployments/docker/Dockerfile.judger
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
    depends_on:
      - mongodb
      - redis
      - rabbitmq
      - go-judge-1
      - go-judge-2
    networks:
      - campus-oj-network
    deploy:
      replicas: 2

  # Nginxè´Ÿè½½å‡è¡¡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../../web/dist:/usr/share/nginx/html
    depends_on:
      - oj-web
    networks:
      - campus-oj-network

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:

networks:
  campus-oj-network:
    driver: bridge
```

### 2. Dockerfileé…ç½®

#### WebæœåŠ¡Dockerfile
**æ–‡ä»¶**: `deployments/docker/Dockerfile.web`
```dockerfile
FROM golang:1.18-alpine AS builder
WORKDIR /app

# å®‰è£…ä¾èµ–
RUN apk add --no-cache git ca-certificates tzdata curl

# å¤åˆ¶å¹¶ä¸‹è½½Goæ¨¡å—
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o server ./cmd/server

# è¿è¡Œé•œåƒ
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata curl
WORKDIR /app

COPY --from=builder /app/server .
RUN mkdir -p /app/logs

ENV TZ=Asia/Shanghai
EXPOSE 8080

# å¥åº·æ£€æŸ¥ - éªŒè¯WebæœåŠ¡å’Œgo-judgeè¿æ¥
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8080/api/v1/health && \
      curl -f http://go-judge-1:5050/version || exit 1

CMD ["./server"]
```

#### åˆ¤é¢˜æœåŠ¡Dockerfile
**æ–‡ä»¶**: `deployments/docker/Dockerfile.judger`
```dockerfile
FROM golang:1.18-alpine AS builder
WORKDIR /app

# å®‰è£…ä¾èµ–
RUN apk add --no-cache git ca-certificates tzdata curl

# å¤åˆ¶å¹¶ä¸‹è½½Goæ¨¡å—
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o judger ./cmd/judger

# è¿è¡Œé•œåƒ
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata curl
WORKDIR /app

COPY --from=builder /app/judger .
RUN mkdir -p /app/logs

ENV TZ=Asia/Shanghai

# go-judgeè¿æ¥å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://go-judge-1:5050/version && \
      curl -f http://go-judge-2:5053/version || exit 1

CMD ["./judger"]
```

### 3. Nginxé…ç½®

**æ–‡ä»¶**: `deployments/docker/nginx/nginx.conf`
```nginx
user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # åŸºç¡€é…ç½®
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;
    
    # ä¸Šæ¸¸æœåŠ¡å™¨
    upstream oj_backend {
        server oj-web:8080;
        keepalive 32;
    }
    
    server {
        listen 80;
        server_name localhost;
        
        # é™æ€æ–‡ä»¶
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        # APIä»£ç†
        location /api/ {
            proxy_pass http://oj_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # WebSocketä»£ç†
        location /api/v1/ws {
            proxy_pass http://oj_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

### 4. é…ç½®æ–‡ä»¶ç®¡ç†

#### å¼€å‘ç¯å¢ƒé…ç½®
**æ–‡ä»¶**: `configs/config.yaml`
```yaml
# æœåŠ¡å™¨é…ç½®
server:
  port: ":8080"
  mode: "debug"
  read_timeout: "60s"
  write_timeout: "60s"

# MongoDBé…ç½®
mongodb:
  uri: "mongodb://admin:campus123@mongodb:27017"
  database: "campus_oj"
  connect_timeout: "10s"
  max_pool_size: 50
  min_pool_size: 5

# Redisé…ç½®
redis:
  host: "redis"
  port: 6379
  password: "campus123"
  db: 0
  pool_size: 20

# RabbitMQé…ç½®
rabbitmq:
  host: "rabbitmq"
  port: 5672
  username: "admin"
  password: "campus123"
  vhost: "/"

# åˆ¤é¢˜é…ç½®
judge:
  # go-judgeæ²™ç®±é›†ç¾¤é…ç½®
  sandboxes:
    - url: "http://go-judge-1:5050"
      weight: 1
      max_concurrent: 10
      timeout: "30s"
      health_check_interval: "10s"
    - url: "http://go-judge-2:5053"
      weight: 1
      max_concurrent: 10
      timeout: "30s"
      health_check_interval: "10s"
  
  # Javaç¼–è¯‘é…ç½®
  compile:
    java:
      command: ["/usr/bin/javac"]
      env:
        - "PATH=/usr/bin:/bin"
        - "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      cpu_limit: 10000000000    # 10ç§’(çº³ç§’)
      memory_limit: 268435456   # 256MB(å­—èŠ‚)
      proc_limit: 50
      file_timeout: 60          # æ–‡ä»¶ç¼“å­˜è¶…æ—¶(ç§’)
  
  # Javaè¿è¡Œé…ç½®
  runtime:
    java:
      command: ["/usr/bin/java"]
      env:
        - "PATH=/usr/bin:/bin"
        - "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      cpu_limit: 5000000000     # 5ç§’(çº³ç§’)
      memory_limit: 134217728   # 128MB(å­—èŠ‚)
      proc_limit: 1
      output_limit: 10240       # 10KB
  
  # æ–‡ä»¶ç®¡ç†
  file_management:
    cleanup_interval: "5m"     # æ¸…ç†é—´éš”
    max_cache_size: "1GB"      # æœ€å¤§ç¼“å­˜å¤§å°
    auto_cleanup: true         # è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶

# JWTé…ç½®
jwt:
  secret: "your-secret-key-change-in-production"
  expire: "24h"

# æ—¥å¿—é…ç½®
logging:
  level: "info"
  format: "json"
  output: "stdout"
  file:
    enabled: true
    path: "/app/logs/app.log"
    max_size: 100     # MB
    max_backups: 10
    max_age: 30       # å¤©
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½®
**æ–‡ä»¶**: `configs/config.prod.yaml`
```yaml
server:
  port: ":8080"
  mode: "release"
  
mongodb:
  uri: "mongodb://admin:${MONGODB_PASSWORD}@mongodb-primary:27017,mongodb-secondary:27018/?replicaSet=rs0"
  max_pool_size: 100
  
redis:
  password: "${REDIS_PASSWORD}"
  pool_size: 50
  
jwt:
  secret: "${JWT_SECRET}"
  expire: "8h"
  
logging:
  level: "warn"
  output: "file"
```

### 5. éƒ¨ç½²è„šæœ¬

#### ä¸€é”®éƒ¨ç½²è„šæœ¬
**æ–‡ä»¶**: `deployments/scripts/deploy.sh`
```bash
#!/bin/bash
set -e

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥Dockerç¯å¢ƒ
check_dependencies() {
    log_info "æ£€æŸ¥ä¾èµ–..."
    
    if ! command -v docker &> /dev/null; then
        log_error "Dockeræœªå®‰è£…"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        log_error "Docker Composeæœªå®‰è£…"
        exit 1
    fi
    
    log_info "ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# ç¯å¢ƒé€‰æ‹©
select_environment() {
    echo "è¯·é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ:"
    echo "1) å¼€å‘ç¯å¢ƒ (development)"
    echo "2) ç”Ÿäº§ç¯å¢ƒ (production)"
    read -p "è¯·è¾“å…¥é€‰æ‹© (1-2): " env_choice
    
    case $env_choice in
        1)
            ENVIRONMENT="development"
            COMPOSE_FILE="docker-compose.yml"
            ;;
        2)
            ENVIRONMENT="production"
            COMPOSE_FILE="docker-compose.prod.yml"
            ;;
        *)
            log_error "æ— æ•ˆé€‰æ‹©"
            exit 1
            ;;
    esac
    
    log_info "é€‰æ‹©ç¯å¢ƒ: $ENVIRONMENT"
}

# é…ç½®æ£€æŸ¥
check_configs() {
    log_info "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
    
    if [ ! -f "configs/config.yaml" ]; then
        log_warn "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä»ç¤ºä¾‹åˆ›å»º..."
        cp configs/config.example.yaml configs/config.yaml
    fi
    
    if [ "$ENVIRONMENT" = "production" ]; then
        required_vars=("MONGODB_PASSWORD" "REDIS_PASSWORD" "JWT_SECRET")
        for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
                log_error "ç¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
                exit 1
            fi
        done
    fi
}

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
deploy_services() {
    log_info "æ„å»ºåº”ç”¨é•œåƒ..."
    cd deployments/docker
    docker-compose -f $COMPOSE_FILE build
    
    log_info "å¯åŠ¨æœåŠ¡..."
    # åˆ†æ­¥å¯åŠ¨æœåŠ¡
    docker-compose -f $COMPOSE_FILE up -d mongodb redis rabbitmq
    sleep 30
    
    docker-compose -f $COMPOSE_FILE up -d go-judge-1 go-judge-2
    sleep 20
    
    docker-compose -f $COMPOSE_FILE up -d oj-web oj-judger
    docker-compose -f $COMPOSE_FILE up -d nginx
    
    log_info "æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ"
}

# å¥åº·æ£€æŸ¥
health_check() {
    log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
    
    max_attempts=30
    attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost/api/v1/health > /dev/null 2>&1; then
            log_info "åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        fi
        
        log_warn "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• ($attempt/$max_attempts)..."
        sleep 10
        ((attempt++))
    done
    
    log_error "å¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}

# æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
show_status() {
    log_info "æœåŠ¡çŠ¶æ€:"
    docker-compose -f $COMPOSE_FILE ps
    
    echo ""
    log_info "è®¿é—®åœ°å€:"
    echo "  Webç•Œé¢: http://localhost"
    echo "  RabbitMQç®¡ç†: http://localhost:15672"
    echo "  APIæ–‡æ¡£: http://localhost/api/v1/docs"
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹éƒ¨ç½²æ ¡å›­Java-OJç³»ç»Ÿ..."
    
    check_dependencies
    select_environment
    check_configs
    deploy_services
    
    if health_check; then
        show_status
        log_info "éƒ¨ç½²æˆåŠŸ! ğŸ‰"
    else
        log_error "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        exit 1
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 6. å¿«é€Ÿå¼€å§‹

#### å¼€å‘ç¯å¢ƒéƒ¨ç½²
```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd campus-java-oj

# 2. å¤åˆ¶é…ç½®æ–‡ä»¶
cp configs/config.example.yaml configs/config.yaml

# 3. ä¸€é”®éƒ¨ç½²
chmod +x deployments/scripts/deploy.sh
./deployments/scripts/deploy.sh

# 4. è®¿é—®ç³»ç»Ÿ
open http://localhost
```

#### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export MONGODB_PASSWORD="your-mongodb-password"
export REDIS_PASSWORD="your-redis-password"
export JWT_SECRET="your-jwt-secret-key"

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬
./deployments/scripts/deploy.sh

# 3. é…ç½®SSLè¯ä¹¦
# å°†SSLè¯ä¹¦æ”¾ç½®åˆ° deployments/docker/nginx/ssl/ ç›®å½•
```

### 7. è¿ç»´ç®¡ç†

#### å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs oj-web
docker-compose logs oj-judger
docker-compose logs go-judge-1

# æµ‹è¯•go-judgeè¿æ¥
curl http://localhost:5050/version
curl http://localhost:5053/version

# é‡å¯æœåŠ¡
docker-compose restart oj-web
docker-compose restart go-judge-1

# æ‰©å®¹æœåŠ¡
docker-compose up -d --scale oj-judger=3
docker-compose up -d --scale go-judge-1=2

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# æ¸…ç†æ•°æ®(è°¨æ…ä½¿ç”¨)
docker-compose down -v

# æŸ¥çœ‹go-judgeæ€§èƒ½æŒ‡æ ‡
curl http://localhost:5050/config
```

#### å¤‡ä»½æ¢å¤
```bash
# MongoDBå¤‡ä»½
docker exec campus-oj-mongodb mongodump --uri="mongodb://admin:campus123@localhost:27017" --out=/backup

# Rediså¤‡ä»½
docker exec campus-oj-redis redis-cli --rdb /data/backup.rdb

# go-judgeç¼“å­˜æ–‡ä»¶æ¸…ç†
curl -X DELETE http://localhost:5050/file/{fileId}

# æ•°æ®æ¢å¤
docker exec campus-oj-mongodb mongorestore --uri="mongodb://admin:campus123@localhost:27017" /backup

# å®šæœŸæ¸…ç†go-judgeç¼“å­˜(æ¯å¤©æ‰§è¡Œ)
echo "0 2 * * * curl -X GET http://localhost:5050/file | jq -r '.[]' | xargs -I {} curl -X DELETE http://localhost:5050/file/{}" | crontab -
```

### 8. ç›‘æ§å‘Šè­¦

#### go-judgeæ²™ç®±ç›‘æ§
- **å®ä¾‹çŠ¶æ€**: å®šæœŸæ£€æŸ¥`/version`æ¥å£
- **æ€§èƒ½æŒ‡æ ‡**: CPUã€å†…å­˜ä½¿ç”¨ç‡ç›‘æ§
- **ç¼–è¯‘æˆåŠŸç‡**: ç›‘æ§Javaç¼–è¯‘æˆåŠŸç‡
- **æ–‡ä»¶ç¼“å­˜**: ç›‘æ§ç¼“å­˜æ–‡ä»¶æ•°é‡å’Œå¤§å°
- **å“åº”æ—¶é—´**: ç¼–è¯‘å’Œè¿è¡Œè¯·æ±‚çš„å“åº”æ—¶é—´

#### ç³»ç»Ÿç›‘æ§
- **åº”ç”¨ç›‘æ§**: `/api/v1/health` å¥åº·æ£€æŸ¥æ¥å£
- **æœåŠ¡ç›‘æ§**: Dockerå®¹å™¨çŠ¶æ€ç›‘æ§
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- **åˆ¤é¢˜é˜Ÿåˆ—**: RabbitMQé˜Ÿåˆ—æ·±åº¦ç›‘æ§
- **æ—¥å¿—ç›‘æ§**: é”™è¯¯æ—¥å¿—å®æ—¶ç›‘æ§

#### å‘Šè­¦é…ç½®
```yaml
# å‘Šè­¦è§„åˆ™ç¤ºä¾‹
alerts:
  - name: "go-judgeå®ä¾‹å¼‚å¸¸"
    condition: "http_status != 200 || response_time > 5s"
    action: "é‡å¯å®ä¾‹å¹¶å‘é€é€šçŸ¥"
    
  - name: "Javaç¼–è¯‘å¤±è´¥ç‡è¿‡é«˜"
    condition: "compile_error_rate > 50%"
    action: "æ£€æŸ¥go-judgeé…ç½®å’ŒJavaç¯å¢ƒ"
    
  - name: "åˆ¤é¢˜é˜Ÿåˆ—ç§¯å‹"
    condition: "queue_depth > 100"
    action: "æ‰©å®¹go-judgeå®ä¾‹æˆ–åˆ¤é¢˜æœåŠ¡"
    
  - name: "æ•°æ®åº“è¿æ¥å¼‚å¸¸"
    condition: "db_connections > 80%"
    action: "é‡å¯æ•°æ®åº“æœåŠ¡"
    
  - name: "go-judgeæ–‡ä»¶ç¼“å­˜è¿‡å¤š"
    condition: "cached_files > 1000 || cache_size > 1GB"
    action: "æ¸…ç†è¿‡æœŸç¼“å­˜æ–‡ä»¶"
```

è¿™ä¸ªéƒ¨ç½²é…ç½®æ–¹æ¡ˆæä¾›äº†ä»å¼€å‘åˆ°ç”Ÿäº§çš„å®Œæ•´éƒ¨ç½²æµç¨‹ï¼Œæ”¯æŒä¸€é”®éƒ¨ç½²ã€å¥åº·æ£€æŸ¥ã€ç›‘æ§å‘Šè­¦ç­‰åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚