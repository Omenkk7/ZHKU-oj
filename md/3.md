# 校园Java-OJ系统部署配置

## 🐳 Docker容器化部署

### 1. 开发环境一键部署

#### Docker Compose配置
**文件**: `deployments/docker/docker-compose.yml`

```yaml
version: '3.8'

services:
  # MongoDB数据库
  mongodb:
    image: mongo:5.0
    container_name: campus-oj-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: campus123
      MONGO_INITDB_DATABASE: campus_oj
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - campus-oj-network

  # Redis缓存
  redis:
    image: redis:6.0-alpine
    command: redis-server --requirepass campus123
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - campus-oj-network

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3.9-management
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: campus123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - campus-oj-network

  # go-judge沙箱集群(基于criyle/go-judge鏜像)
  go-judge-1:
    image: criyle/go-judge:latest
    privileged: true
    shm_size: 256m
    ports:
      - "5050:5050"
    environment:
      - PARALLELISM=4
      - FILE_TIMEOUT=60
      - HTTP_TIMEOUT=30
    volumes:
      - /tmp:/tmp
    networks:
      - campus-oj-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/version"]
      interval: 30s
      timeout: 10s
      retries: 3

  go-judge-2:
    image: criyle/go-judge:latest
    privileged: true
    shm_size: 256m
    ports:
      - "5053:5050"
    environment:
      - PARALLELISM=4
      - FILE_TIMEOUT=60
      - HTTP_TIMEOUT=30
    volumes:
      - /tmp:/tmp
    networks:
      - campus-oj-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Web服务
  oj-web:
    build:
      context: ../../
      dockerfile: deployments/docker/Dockerfile.web
    ports:
      - "8080:8080"
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
    volumes:
      - ../../configs:/app/configs
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - campus-oj-network

  # 判题服务
  oj-judger:
    build:
      context: ../../
      dockerfile: deployments/docker/Dockerfile.judger
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
    depends_on:
      - mongodb
      - redis
      - rabbitmq
      - go-judge-1
      - go-judge-2
    networks:
      - campus-oj-network
    deploy:
      replicas: 2

  # Nginx负载均衡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../../web/dist:/usr/share/nginx/html
    depends_on:
      - oj-web
    networks:
      - campus-oj-network

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:

networks:
  campus-oj-network:
    driver: bridge
```

### 2. Dockerfile配置

#### Web服务Dockerfile
**文件**: `deployments/docker/Dockerfile.web`
```dockerfile
FROM golang:1.18-alpine AS builder
WORKDIR /app

# 安装依赖
RUN apk add --no-cache git ca-certificates tzdata curl

# 复制并下载Go模块
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码并构建
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o server ./cmd/server

# 运行镜像
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata curl
WORKDIR /app

COPY --from=builder /app/server .
RUN mkdir -p /app/logs

ENV TZ=Asia/Shanghai
EXPOSE 8080

# 健康检查 - 验证Web服务和go-judge连接
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8080/api/v1/health && \
      curl -f http://go-judge-1:5050/version || exit 1

CMD ["./server"]
```

#### 判题服务Dockerfile
**文件**: `deployments/docker/Dockerfile.judger`
```dockerfile
FROM golang:1.18-alpine AS builder
WORKDIR /app

# 安装依赖
RUN apk add --no-cache git ca-certificates tzdata curl

# 复制并下载Go模块
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码并构建
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o judger ./cmd/judger

# 运行镜像
FROM alpine:latest
RUN apk --no-cache add ca-certificates tzdata curl
WORKDIR /app

COPY --from=builder /app/judger .
RUN mkdir -p /app/logs

ENV TZ=Asia/Shanghai

# go-judge连接健康检查
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://go-judge-1:5050/version && \
      curl -f http://go-judge-2:5053/version || exit 1

CMD ["./judger"]
```

### 3. Nginx配置

**文件**: `deployments/docker/nginx/nginx.conf`
```nginx
user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 基础配置
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 50M;
    
    # Gzip压缩
    gzip on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;
    
    # 上游服务器
    upstream oj_backend {
        server oj-web:8080;
        keepalive 32;
    }
    
    server {
        listen 80;
        server_name localhost;
        
        # 静态文件
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        # API代理
        location /api/ {
            proxy_pass http://oj_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 超时设置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # WebSocket代理
        location /api/v1/ws {
            proxy_pass http://oj_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

### 4. 配置文件管理

#### 开发环境配置
**文件**: `configs/config.yaml`
```yaml
# 服务器配置
server:
  port: ":8080"
  mode: "debug"
  read_timeout: "60s"
  write_timeout: "60s"

# MongoDB配置
mongodb:
  uri: "mongodb://admin:campus123@mongodb:27017"
  database: "campus_oj"
  connect_timeout: "10s"
  max_pool_size: 50
  min_pool_size: 5

# Redis配置
redis:
  host: "redis"
  port: 6379
  password: "campus123"
  db: 0
  pool_size: 20

# RabbitMQ配置
rabbitmq:
  host: "rabbitmq"
  port: 5672
  username: "admin"
  password: "campus123"
  vhost: "/"

# 判题配置
judge:
  # go-judge沙箱集群配置
  sandboxes:
    - url: "http://go-judge-1:5050"
      weight: 1
      max_concurrent: 10
      timeout: "30s"
      health_check_interval: "10s"
    - url: "http://go-judge-2:5053"
      weight: 1
      max_concurrent: 10
      timeout: "30s"
      health_check_interval: "10s"
  
  # Java编译配置
  compile:
    java:
      command: ["/usr/bin/javac"]
      env:
        - "PATH=/usr/bin:/bin"
        - "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      cpu_limit: 10000000000    # 10秒(纳秒)
      memory_limit: 268435456   # 256MB(字节)
      proc_limit: 50
      file_timeout: 60          # 文件缓存超时(秒)
  
  # Java运行配置
  runtime:
    java:
      command: ["/usr/bin/java"]
      env:
        - "PATH=/usr/bin:/bin"
        - "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      cpu_limit: 5000000000     # 5秒(纳秒)
      memory_limit: 134217728   # 128MB(字节)
      proc_limit: 1
      output_limit: 10240       # 10KB
  
  # 文件管理
  file_management:
    cleanup_interval: "5m"     # 清理间隔
    max_cache_size: "1GB"      # 最大缓存大小
    auto_cleanup: true         # 自动清理过期文件

# JWT配置
jwt:
  secret: "your-secret-key-change-in-production"
  expire: "24h"

# 日志配置
logging:
  level: "info"
  format: "json"
  output: "stdout"
  file:
    enabled: true
    path: "/app/logs/app.log"
    max_size: 100     # MB
    max_backups: 10
    max_age: 30       # 天
```

#### 生产环境配置
**文件**: `configs/config.prod.yaml`
```yaml
server:
  port: ":8080"
  mode: "release"
  
mongodb:
  uri: "mongodb://admin:${MONGODB_PASSWORD}@mongodb-primary:27017,mongodb-secondary:27018/?replicaSet=rs0"
  max_pool_size: 100
  
redis:
  password: "${REDIS_PASSWORD}"
  pool_size: 50
  
jwt:
  secret: "${JWT_SECRET}"
  expire: "8h"
  
logging:
  level: "warn"
  output: "file"
```

### 5. 部署脚本

#### 一键部署脚本
**文件**: `deployments/scripts/deploy.sh`
```bash
#!/bin/bash
set -e

# 颜色定义
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查Docker环境
check_dependencies() {
    log_info "检查依赖..."
    
    if ! command -v docker &> /dev/null; then
        log_error "Docker未安装"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        log_error "Docker Compose未安装"
        exit 1
    fi
    
    log_info "依赖检查通过"
}

# 环境选择
select_environment() {
    echo "请选择部署环境:"
    echo "1) 开发环境 (development)"
    echo "2) 生产环境 (production)"
    read -p "请输入选择 (1-2): " env_choice
    
    case $env_choice in
        1)
            ENVIRONMENT="development"
            COMPOSE_FILE="docker-compose.yml"
            ;;
        2)
            ENVIRONMENT="production"
            COMPOSE_FILE="docker-compose.prod.yml"
            ;;
        *)
            log_error "无效选择"
            exit 1
            ;;
    esac
    
    log_info "选择环境: $ENVIRONMENT"
}

# 配置检查
check_configs() {
    log_info "检查配置文件..."
    
    if [ ! -f "configs/config.yaml" ]; then
        log_warn "配置文件不存在，从示例创建..."
        cp configs/config.example.yaml configs/config.yaml
    fi
    
    if [ "$ENVIRONMENT" = "production" ]; then
        required_vars=("MONGODB_PASSWORD" "REDIS_PASSWORD" "JWT_SECRET")
        for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
                log_error "环境变量 $var 未设置"
                exit 1
            fi
        done
    fi
}

# 构建和启动服务
deploy_services() {
    log_info "构建应用镜像..."
    cd deployments/docker
    docker-compose -f $COMPOSE_FILE build
    
    log_info "启动服务..."
    # 分步启动服务
    docker-compose -f $COMPOSE_FILE up -d mongodb redis rabbitmq
    sleep 30
    
    docker-compose -f $COMPOSE_FILE up -d go-judge-1 go-judge-2
    sleep 20
    
    docker-compose -f $COMPOSE_FILE up -d oj-web oj-judger
    docker-compose -f $COMPOSE_FILE up -d nginx
    
    log_info "所有服务启动完成"
}

# 健康检查
health_check() {
    log_info "执行健康检查..."
    
    max_attempts=30
    attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost/api/v1/health > /dev/null 2>&1; then
            log_info "应用健康检查通过"
            return 0
        fi
        
        log_warn "健康检查失败，重试 ($attempt/$max_attempts)..."
        sleep 10
        ((attempt++))
    done
    
    log_error "健康检查失败"
    return 1
}

# 显示部署结果
show_status() {
    log_info "服务状态:"
    docker-compose -f $COMPOSE_FILE ps
    
    echo ""
    log_info "访问地址:"
    echo "  Web界面: http://localhost"
    echo "  RabbitMQ管理: http://localhost:15672"
    echo "  API文档: http://localhost/api/v1/docs"
}

# 主函数
main() {
    log_info "开始部署校园Java-OJ系统..."
    
    check_dependencies
    select_environment
    check_configs
    deploy_services
    
    if health_check; then
        show_status
        log_info "部署成功! 🎉"
    else
        log_error "部署失败，请检查日志"
        exit 1
    fi
}

# 执行主函数
main "$@"
```

### 6. 快速开始

#### 开发环境部署
```bash
# 1. 克隆项目
git clone <repository-url>
cd campus-java-oj

# 2. 复制配置文件
cp configs/config.example.yaml configs/config.yaml

# 3. 一键部署
chmod +x deployments/scripts/deploy.sh
./deployments/scripts/deploy.sh

# 4. 访问系统
open http://localhost
```

#### 生产环境部署
```bash
# 1. 设置环境变量
export MONGODB_PASSWORD="your-mongodb-password"
export REDIS_PASSWORD="your-redis-password"
export JWT_SECRET="your-jwt-secret-key"

# 2. 运行部署脚本
./deployments/scripts/deploy.sh

# 3. 配置SSL证书
# 将SSL证书放置到 deployments/docker/nginx/ssl/ 目录
```

### 7. 运维管理

#### 常用命令
```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs oj-web
docker-compose logs oj-judger
docker-compose logs go-judge-1

# 测试go-judge连接
curl http://localhost:5050/version
curl http://localhost:5053/version

# 重启服务
docker-compose restart oj-web
docker-compose restart go-judge-1

# 扩容服务
docker-compose up -d --scale oj-judger=3
docker-compose up -d --scale go-judge-1=2

# 停止所有服务
docker-compose down

# 清理数据(谨慎使用)
docker-compose down -v

# 查看go-judge性能指标
curl http://localhost:5050/config
```

#### 备份恢复
```bash
# MongoDB备份
docker exec campus-oj-mongodb mongodump --uri="mongodb://admin:campus123@localhost:27017" --out=/backup

# Redis备份
docker exec campus-oj-redis redis-cli --rdb /data/backup.rdb

# go-judge缓存文件清理
curl -X DELETE http://localhost:5050/file/{fileId}

# 数据恢复
docker exec campus-oj-mongodb mongorestore --uri="mongodb://admin:campus123@localhost:27017" /backup

# 定期清理go-judge缓存(每天执行)
echo "0 2 * * * curl -X GET http://localhost:5050/file | jq -r '.[]' | xargs -I {} curl -X DELETE http://localhost:5050/file/{}" | crontab -
```

### 8. 监控告警

#### go-judge沙箱监控
- **实例状态**: 定期检查`/version`接口
- **性能指标**: CPU、内存使用率监控
- **编译成功率**: 监控Java编译成功率
- **文件缓存**: 监控缓存文件数量和大小
- **响应时间**: 编译和运行请求的响应时间

#### 系统监控
- **应用监控**: `/api/v1/health` 健康检查接口
- **服务监控**: Docker容器状态监控
- **资源监控**: CPU、内存、磁盘使用率
- **判题队列**: RabbitMQ队列深度监控
- **日志监控**: 错误日志实时监控

#### 告警配置
```yaml
# 告警规则示例
alerts:
  - name: "go-judge实例异常"
    condition: "http_status != 200 || response_time > 5s"
    action: "重启实例并发送通知"
    
  - name: "Java编译失败率过高"
    condition: "compile_error_rate > 50%"
    action: "检查go-judge配置和Java环境"
    
  - name: "判题队列积压"
    condition: "queue_depth > 100"
    action: "扩容go-judge实例或判题服务"
    
  - name: "数据库连接异常"
    condition: "db_connections > 80%"
    action: "重启数据库服务"
    
  - name: "go-judge文件缓存过多"
    condition: "cached_files > 1000 || cache_size > 1GB"
    action: "清理过期缓存文件"
```

这个部署配置方案提供了从开发到生产的完整部署流程，支持一键部署、健康检查、监控告警等功能，确保系统稳定运行。